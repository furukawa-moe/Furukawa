/*
*  calligraphy.js
* 
*  Copyright © Ming Wong
*  Licensed under the MIT license.
* 
*  Adapted from the original example at https://github.com/chakming/HTML5-Chinese-Calligraphy
*/
function delegate(t,e){return function(){e.apply(t,arguments)}}function bind(t){var e=arguments;return function(){for(var i=[],s=1;s<e.length;++s)i.push(e[s]);for(s=0;s<arguments.length;++s)i.push(arguments[s]);t.apply(this,i)}}!function(){var t=!1,e=/xyz/.test((function(){xyz}))?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){var s=this.prototype;t=!0;var n=new this;for(var o in t=!1,i)n[o]="function"==typeof i[o]&&"function"==typeof s[o]&&e.test(i[o])?function(t,e){return function(){var i=this._super;this._super=s[t];var n=e.apply(this,arguments);return this._super=i,n}}(o,i[o]):i[o];function a(){!t&&this.init&&this.init.apply(this,arguments)}return a.prototype=n,a.constructor=a,a.extend=arguments.callee,a}}();var History=Class.extend({init:function(t){this._capacity=t,this._array=[]},clear:function(){this._array=[]},remove:function(t,e){this._array.splice(t,e)},push:function(t){this._array.length==this._capacity&&this._array.shift(),this._array.push(t)},getAt:function(t){if(t<0||t>=this._array.length)throw"index out of range";return this._array[t]},getLength:function(){return this._array.length},getCapacity:function(){return this._capacity},getArray:function(){return this._array},isFull:function(){return this._capacity==this._array.length}}),Tool=Class.extend({init:function(t,e){},dispose:function(){},mousedown:function(t,e){},mouseup:function(t,e){},mousemove:function(t,e){},mousehover:function(t,e){},mouseout:function(t,e){}}),VirtualPaper=Class.extend({_Canvas:null,init:function(t){this._Canvas=t},dispose:function(){}}),MathEx={distance:function(t,e,i,s){return Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))},distanceArray:function(t){if(t.length<2)return 0;for(var e=0,i=0;i<t.length-1;++i)e+=MathEx.distance(t[i].x,t[i].y,t[i+1].x,t[i+1].y);return e},bounded:function(t,e,i){return Math.min(i,Math.max(e,t))},random:function(t,e){return Math.random()*(e-t)+t},lawOfCosine:function(t,e,i,s,n,o){var a=this.distance(i,s,t,e),h=this.distance(n,o,t,e),r=this.distance(n,o,i,s);return Math.acos((a*a+h*h-r*r)/(2*a*h))},Interpolate:{cubic:function(t,e,i,s,n){var o;return(-.5*t+1.5*e-1.5*i+.5*s)*n*(o=n*n)+(t-2.5*e+2*i-.5*s)*o+(-.5*t+.5*i)*n+e},hermite1d:function(t,e,i,s,n,o,a){var h,r,u,c;return h=(e-t)*(1+a)*(1-o)/2,r=(i-e)*(1+a)*(1-o)/2,(2*(c=(u=n*n)*n)-3*u+1)*e+(c-2*u+n)*(h+=(i-e)*(1-a)*(1-o)/2)+(c-u)*(r+=(s-i)*(1-a)*(1-o)/2)+(-2*c+3*u)*i},hermite2d:function(t,e,i,s,n,o,a){var h={x:0,y:0};return h.x=this.hermite1d(t.x,e.x,i.x,s.x,n,o,a),h.y=this.hermite1d(t.y,e.y,i.y,s.y,n,o,a),h}},Dampener:Class.extend({_a:[],_n:0,init:function(t){this._n=t},push:function(t){this._a.push(t),this._a.length>this._n&&this._a.shift();t=0;for(var e=0;e<this._a.length;++e)t+=this._a[e];return t/this._a.length}})};function resizeCanvas(){canvas.width=document.body.clientWidth,canvas.height=document.body.clientHeight;const t=Math.max(window.devicePixelRatio||1,1);canvas.width=canvas.offsetWidth*t,canvas.height=canvas.offsetHeight*t,canvas.getContext("2d").scale(t,t)}window.Html5Paint||(window.Html5Paint={}),Html5Paint.Resources||(Html5Paint.Resources={}),Html5Paint.Resources={createImage:function(t){var e=document.createElement("img");return e.src=t,e},getImage:function(t,e){return this[t][e]}},Html5Paint.Resources.KasureBrushes={Small:Html5Paint.Resources.createImage("./img/stroke.png")},window.addEventListener("load",(function(){canvas=document.querySelector("canvas"),window.addEventListener("resize",resizeCanvas),resizeCanvas();VirtualPaper.extend({init:function(t,e){this._super(t,e),this._Canvas=document.getElementById(t),this._Content=this._Canvas.getContext("2d")}});window.ChineseCalligraphyBrush=Tool.extend({config:{offset:{x:0,y:0},size:{name:"PaintBrush Size",type:"range",min:0,max:10,step:.5,value:5}},_virtualPaper:null,_lastPosition:null,_lastMoveTime:null,_velocityDampener:0,init:function(t,e,i){this.config.offset=$.extend(this.config.offset,i),this._canvasElement=t,this._context=this._canvasElement.getContext("2d"),this.previousBrushSize=0,this.splineBuffer=[],this.previousVelocity=0,this.already=!0,$(this),console.log("!")},dispose:function(){},mousedown:function(t,e,i,s){this.previousBrushSize=0,this.brushUsing=null,this.splineBuffer=null,this.splineBuffer=[],this.drawStroke(t,e,i,s,!1),this._lastPosition={x:i,y:s},this._lastMoveTime=(new Date).getTime(),this.already=!1},mouseup:function(t,e,i,s){this.drawStroke(this._lastPosition.x,this._lastPosition.y,t,e,!0),this._lastPosition={x:t,y:e},this._lastMoveTime=(new Date).getTime()},mousemove:function(t,e,i,s){this.drawStroke(this._lastPosition.x,this._lastPosition.y,t,e,!1),this._lastPosition={x:t,y:e},this._lastMoveTime=(new Date).getTime()},mousehover:function(t,e){},mouseout:function(t,e){},drawLine:function(t,e,i,s,n,o,a){return this._context.beginPath(),this._context.moveTo(t,e),this._context.lineTo(i,s),this._context.stroke({lineWidth:1,strokeStyle:"round",lineCap:"round"}),this},curve:function(t,e,i,s){return i*t/s+e},drawStroke:function(t,e,i,s,n){if(t-=this.config.offset.x,e-=this.config.offset.y,i-=this.config.offset.x,s-=this.config.offset.y,0!=i||0!=s){this.splineBuffer.push({x:i,y:s});var o=Html5Paint.Resources.KasureBrushes.Small;if(this.splineBuffer.length>3){var a=(new Date).getTime()-this._lastMoveTime,h=MathEx.distance(t,e,i,s)/Math.max(1,a),r=(0==this.previousVelocity||this.previousVelocity,Math.max(this.config.size.min,this.curve(h,this.config.size.max,-this.config.size.max-this.config.size.min,5))),u=(this.splineBuffer.length,Array.apply(null,this.splineBuffer));(u=u.slice(u.length-4)).unshift(u[0]),u.push(u[u.length-1]);for(var c=0,l=u.length-3;c<l;c++)for(var f=u[c],_=u[c+1],p=u[c+2],v=u[c+3],d={x:(p.x-f.x)/2,y:(p.y-f.y)/2,s:p.s-f.s},g={x:(v.x-_.x)/2,y:(v.y-_.y)/2,s:v.s-_.s},m=2*_.x-2*p.x+d.x+g.x,y=-3*_.x+3*p.x-2*d.x-g.x,x=2*_.y-2*p.y+d.y+g.y,w=-3*_.y+3*p.y-2*d.y-g.y,M=1;M<=41;M++){var S=M/40,P=m*Math.pow(S,3)+y*Math.pow(S,2)+d.x*S+_.x,E=x*Math.pow(S,3)+w*Math.pow(S,2)+d.y*S+_.y,C=this.previousBrushSize+(r-this.previousBrushSize)/40*M;this.previousBrushSize==r&&Math.random()<.3||this._context.drawImage(o,P-C/2,E-C/2,C,C)}this.previousBrushSize=r,this.already=!0,u.length=0}}},drawStrokeOld:function(t,e,i,s,n,o,a){for(var h=t,r=e,u=(i-t)/2,c=(s-e)/2,l=(i-t)/2,f=(s-e)/2,_=2*h-2*i+u+l,p=-3*h+3*i-2*u-l,v=2*r-2*s+c+f,d=-3*r+3*s-2*c-f,g=1;g<=41;g++){var m=g/40,y=_*Math.pow(m,3)+p*Math.pow(m,2)+u*m+h,x=v*Math.pow(m,3)+d*Math.pow(m,2)+c*m+r,w=this.previousBrushSize+(n-this.previousBrushSize)/40*g;this.previousBrushSize==n&&Math.random()<.3||this._context.drawImage(Html5Paint.Resources.KasureBrushes.Small,y-w/2,x-w/2,w,w)}}});var t=Class.extend({_config:{isEaserMode:!1,fillColor:"rgba(0,0,0,0.25)",pencilWidth:25,oldFillStyle:null},_canvasElement:null,_sharedCanvasElement:null,_updateCallback:null,_width:null,_height:null,_offset:{x:0,y:0},init:function(t,e,i){this._offset=i,this._canvasElement=t,this._width=t.width,this._height=t.height,this._updateCallback=e,this._initEventHandlers(),this._prevMousePoint=[0,0],this._prevSmoothMousePoint=[0,0],this._prevMouseChangeVector=[0,0],this._mouseSmoothingFactor=.3,this._lastRotation=Math.PI/2,this._ctx=this._canvasElement.getContext("2d"),this._config.oldFillStyle=this._ctx.fillStyle,this._config.oldLineWidth=this._ctx.lineWidth,this.isDrawing=!1,this.penStyle="art",this.easerPenWidth=40,this.eventBinded=!1},setTool:function(t){return this._activeTool instanceof Tool&&this._activeTool.dispose(),this._canvasElement.style.cursor="crosshair",this._activeTool=new window[t](this._canvasElement,null,this._offset),this._activeTool},getImageDataUrl:function(){return this._canvasElement.getNativeCanvas().toDataURL()},_initEventHandlers:function(){this._canvasElement.addEventListener("mousedown",delegate(this,this._onDrawStart),!1),this._canvasElement.addEventListener("touchstart",delegate(this,this._onDrawStart),!1),this._canvasElement.addEventListener("mousemove.Hover",delegate(this,this._onMouseHover),!1),this._canvasElement.addEventListener("mouseout.Hover",delegate(this,this._onMouseOut),!1)},_penStyleChanged:function(t,e,i,s){switch(this.penStyle){case"pen":this._ctx.beginPath(),this._ctx.moveTo(t,e);break;case"easer":this._ctx.beginPath()}},_onDrawStart:function(t){if(this.isDrawing=!0,t.preventDefault(),t.stopPropagation(),t.touches&&(t=t.touches[0]),this._activeTool instanceof Tool){var e=t.pageX-this._canvasElement.offsetLeft,i=t.pageY-this._canvasElement.offsetTop;this._resetMouseSmoothing(e,i),this._penStyleChanged(e-this._offset.x,i-this._offset.y,t.pageX,t.pageY),this._activeTool.mousedown(e,i,t.pageX,t.pageY),this.eventBinded||($(this._canvasElement).bind("mousemove",delegate(this,this._onDrawMove),!1).bind("mouseup",delegate(this,this._onDrawEnd),!1),this._canvasElement.addEventListener("touchmove",delegate(this,this._onDrawMove),!1),this._canvasElement.addEventListener("touchend",delegate(this,this._onDrawEnd),!1),this.eventBinded=!0)}},_onDrawEnd:function(t){t.preventDefault(),t.stopPropagation(),this.isDrawing=!1;var e=this._getSmoothMousePoint(t.pageX-this._canvasElement.offsetLeft,t.pageY-this._canvasElement.offsetTop);$(this._canvasElement).unbind(".Draw"),$("body").unbind(".Draw"),this._activeTool.mouseup(e[0],e[1],t.pageX,t.pageY)},_onDrawMove:function(t){if(this.isDrawing){t.preventDefault(),t.stopPropagation(),t.touches&&(t=t.touches[0]);var e=this._getSmoothMousePoint(t.pageX-this._canvasElement.offsetLeft,t.pageY-this._canvasElement.offsetTop),i={x:e[0]-this._offset.x,y:e[1]-this._offset.y};switch(this.penStyle){case"pen":this._ctx.lineTo(i.x,i.y),this._ctx.stroke();break;case"easer":this._ctx.arc(i.x,i.y,this.easerPenWidth,0,2*Math.PI,!0),this._ctx.fill();break;default:this._activeTool.mousemove(e[0],e[1],t.pageX,t.pageY)}}},_onMouseHover:function(t){t.preventDefault(),t.touches&&(t=t.touches[0]),this._activeTool.mousehover(t.pageX-this._canvasElement.offsetLeft,t.pageY-this._canvasElement.offsetTop,t.pageX,t.pageY)},_onMouseOut:function(t){t.preventDefault(),t.touches&&(t=t.touches[0]),this._activeTool.mouseout(t.pageX-this._canvasElement.offsetLeft,t.pageY-this._canvasElement.offsetTop,t.pageX,t.pageY)},_resetMouseSmoothing:function(t,e){this._prevMousePoint=this._prevSmoothMousePoint=[t,e],this._lastRotation=Math.PI/2,this._prevMouseChangeVector=[0,0]},_getSmoothMousePoint:function(t,e){var i=[t-this._prevMousePoint[0],e-this._prevMousePoint[1]],s=this._prevSmoothMousePoint[0],n=this._prevSmoothMousePoint[1];i[0]*this._prevMouseChangeVector[0]+i[1]*this._prevMouseChangeVector[1]<0&&(s=this._prevSmoothMousePoint[0]=this._prevMousePoint[0],n=this._prevSmoothMousePoint[1]=this._prevMousePoint[1],this._lastRotation+=Math.PI),this._prevMouseChangeVector=i,this._prevMousePoint=[t,e],s+=this._mouseSmoothingFactor*(t-s),n+=this._mouseSmoothingFactor*(e-n);var o=s-this._prevSmoothMousePoint[0],a=s-this._prevSmoothMousePoint[1];Math.sqrt(o*o+a*a);return this._prevSmoothMousePoint=[s,n],[s,n]},clear:function(){this._ctx.clearRect(0,0,this._width,this._height)},drawStyle:function(t){if("pen"===t)this.penStyle="pen";else this.penStyle="art"},drawMode:function(t){if("easer"===t)this._config.isEaserMode=!0,this._ctx.globalCompositeOperation="destination-out",this._ctx.fillStyle=this._config.fillColor,this.penStyle="easer";else this._ctx.globalCompositeOperation="source-over",this._ctx.fillStyle=this._config.oldFillStyle,this._ctx.lineWidth=this._config.oldLineWidth,this._config.isEaserMode=!1}}),e=Class.extend({_config:{width:200,height:200,offset:{x:0,y:0},tools:[{type:"ChineseCalligraphyBrush",description:"Chinese Calligraphy Brush",icon:"tool-icon-chinese-calligraphy-brush",cursor:"crosshair"}],virtualPaper:[{type:"NormalPaper",description:"Normal Paper",icon:"paper-icon-normal-paper",cursor:"crosshair"}]},init:function(t){var e="#"+t,i=$(e).offset();this._config.offset={x:i.left,y:i.top},this._config.width=$(e).width(),this._config.height=$(e).height(),this._initSurface(t),this._initTools()},_initSurface:function(e){this._canvas=document.getElementById(e),this._surface=new t(this._canvas,null,this._config.offset)},_initTools:function(){var t=this._config.tools[0];this._surface.setTool(t.type)},_handleWindowResize:function(){},_resetCanvas:function(){}});window.app=new e("canvas")}),!1);